name: Daily Report Upload

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 02:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 10:00
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  upload-latest-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“… Get date
      id: date
      run: |
        echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        echo "year=$(date +%Y)" >> $GITHUB_OUTPUT
        echo "month=$(date +%m)" >> $GITHUB_OUTPUT

    - name: Find latest report
      id: find_report
      run: |
        DATE=${{ steps.date.outputs.date }}
        YEAR=${{ steps.date.outputs.year }}
        MONTH=${{ steps.date.outputs.month }}

        # ä» data ç›®å½•æŸ¥æ‰¾ä»Šå¤©çš„ JSON æŠ¥å‘Š
        report_file="data/$YEAR/$MONTH/$DATE.json"

        if [ -f "$report_file" ]; then
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°ä»Šæ—¥æŠ¥å‘Š: $report_file"
        else
          # å¦‚æœæ²¡æœ‰ä»Šå¤©çš„æŠ¥å‘Šï¼ŒæŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Š
          latest_file=$(find data -type f -name "*.json" | sort -r | head -n 1)
          if [ -z "$latest_file" ]; then
            echo "æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶"
            exit 1
          fi
          echo "report_file=$latest_file" >> $GITHUB_OUTPUT
          echo "ä½¿ç”¨æœ€æ–°æŠ¥å‘Š: $latest_file"
        fi

    - name: Send to DingTalk
      env:
        DINGDING_TOKEN: ${{ secrets.DINGDING_TOKEN }}
        REPORT_FILE: ${{ steps.find_report.outputs.report_file }}
        DATE: ${{ steps.date.outputs.date }}
        SITE_URL: "https://wayyoungboy.github.io/github-trending-reporter/"
        REPO_URL: "https://github.com/${{ github.repository }}"
      run: |
        # å¦‚æœæ²¡æœ‰é…ç½® token å°±å®‰å…¨åœ°è·³è¿‡ï¼ˆé¿å…åœ¨ workflow æ ¡éªŒé˜¶æ®µå¼•ç”¨ secrets å¯¼è‡´é”™è¯¯ï¼‰
        if [ -z "$DINGDING_TOKEN" ]; then
          echo "DINGDING_TOKEN æœªé…ç½®ï¼Œè·³è¿‡å‘é€"
          exit 0
        fi

        python3 - <<'PY'
        import json, os

        report_file = os.environ['REPORT_FILE']
        date = os.environ['DATE']
        site_url = os.environ['SITE_URL']
        repo_url = os.environ['REPO_URL']

        # è¯»å– JSON æ•°æ®
        with open(report_file, 'r', encoding='utf-8') as f:
            data = json.load(f)

            # æ„å»ºç®€æ´çš„ Markdown æ¶ˆæ¯
            content = ""
            for i, repo in enumerate(data['repositories'], 1):
                emoji = ["1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£"][i-1]
                content += f"### {emoji} **{repo['full_name']}**\n"
                content += f"- **è¯­è¨€**: {repo['language']}\n"
                content += f"- **å¢é•¿**: +{repo['stars_today']} â­ (ä»Šæ—¥)\n"
                content += f"- **æ€»è®¡**: {repo['stars']} â­\n"
                content += f"- **ç®€ä»‹**: {repo['description']}\n\n"

            # æ„å»ºæ¶ˆæ¯ï¼ˆMarkdownï¼‰
            message = {
                'msgtype': 'markdown',
                'markdown': {
                    'title': f'æ¯æ—¥GitHubè¶‹åŠ¿æŠ¥å‘Š - {date}',
                    'text': (
                        f'### ğŸ“ˆ GitHubè¶‹åŠ¿æ¯æ—¥æŠ¥å‘Š\n\n'
                        f'**ğŸ“… æ—¥æœŸ**: {date}\n'
                        f'**ğŸ“Š é¡¹ç›®æ€»æ•°**: {data["total_repos"]}ä¸ª\n'
                        f'**ğŸ”¥ æœ€çƒ­é—¨**: {data["repositories"][0]["full_name"]} (+{data["repositories"][0]["stars_today"]}â­)\n\n'
                        f'**ğŸ“± ä»Šæ—¥çƒ­é—¨é¡¹ç›®**: \n{content}\n'
                        f'**[æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š]({site_url})** | **[é¡¹ç›®ä»“åº“]({repo_url})**'
                    )
                }
            }
            print(json.dumps(message))
            open('dingtalk_message.json', 'w', encoding='utf-8').write(json.dumps(message, ensure_ascii=False))


        PY
        curl "https://oapi.dingtalk.com/robot/send?access_token=$DINGDING_TOKEN" \
          -H 'Content-Type: application/json' \
          -d @dingtalk_message.json