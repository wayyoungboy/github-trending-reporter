name: Daily Report Upload

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 02:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 10:00
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  upload-latest-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“… Get date
      id: date
      run: |
        echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        echo "year=$(date +%Y)" >> $GITHUB_OUTPUT
        echo "month=$(date +%m)" >> $GITHUB_OUTPUT

    - name: Find latest report
      id: find_report
      run: |
        DATE=${{ steps.date.outputs.date }}
        YEAR=${{ steps.date.outputs.year }}
        MONTH=${{ steps.date.outputs.month }}

        # æ ¹æ® daily_report.yml çš„ç›®å½•ç»“æ„æŸ¥æ‰¾ä»Šå¤©çš„æŠ¥å‘Š
        report_file="reports/$YEAR/$MONTH/$DATE.md"

        if [ -f "$report_file" ]; then
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°ä»Šæ—¥æŠ¥å‘Š: $report_file"
        else
          # å¦‚æœæ²¡æœ‰ä»Šå¤©çš„æŠ¥å‘Šï¼ŒæŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Š
          latest_file=$(find reports -type f -name "*.md" | sort -r | head -n 1)
          if [ -z "$latest_file" ]; then
            echo "æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶"
            exit 1
          fi
          echo "report_file=$latest_file" >> $GITHUB_OUTPUT
          echo "ä½¿ç”¨æœ€æ–°æŠ¥å‘Š: $latest_file"
        fi

    - name: Send to DingTalk
      env:
        DINGDING_TOKEN: ${{ secrets.DINGDING_TOKEN }}
        REPORT_FILE: ${{ steps.find_report.outputs.report_file }}
        DATE: ${{ steps.date.outputs.date }}
        SITE_URL: "https://wayyoungboy.github.io/github-trending-reporter/"
        REPO_URL: "https://github.com/${{ github.repository }}"
      run: |
        # å¦‚æœæ²¡æœ‰é…ç½® token å°±å®‰å…¨åœ°è·³è¿‡ï¼ˆé¿å…åœ¨ workflow æ ¡éªŒé˜¶æ®µå¼•ç”¨ secrets å¯¼è‡´é”™è¯¯ï¼‰
        if [ -z "$DINGDING_TOKEN" ]; then
          echo "DINGDING_TOKEN æœªé…ç½®ï¼Œè·³è¿‡å‘é€"
          exit 0
        fi

        python3 - <<'PY'
        import json, os

        report_file = os.environ['REPORT_FILE']
        date = os.environ['DATE']
        site_url = os.environ['SITE_URL']
        repo_url = os.environ['REPO_URL']

        with open(report_file, 'r', encoding='utf-8') as f:
            content = f.read()

        # æ„å»ºæ¶ˆæ¯ï¼ˆMarkdownï¼‰
        message = {
            'msgtype': 'markdown',
            'markdown': {
                'title': f'æ¯æ—¥GitHubè¶‹åŠ¿æŠ¥å‘Š - {date}',
                'text': (
                    f'### **GitHubè¶‹åŠ¿æ¯æ—¥æŠ¥å‘Š** ğŸš€\n\n'
                    f'#### **æŠ¥å‘Šæ—¥æœŸ**: {date}\n'
                    f'#### **åœ¨çº¿æŸ¥çœ‹**: [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š]({site_url})\n\n'
                    '---\n\n'
                    '**æŠ¥å‘Šå†…å®¹**:\n\n'
                    f'{content}\n\n'
                    '---\n\n'
                    f'[ä»“åº“]({repo_url})'
                )
            }
        }
        print("å‘é€æ¶ˆæ¯å†…å®¹:")
        print(json.dumps(message, ensure_ascii=False, indent=2))

        with open('dingtalk_message.json', 'w', encoding='utf-8') as f:
            json.dump(message, f, ensure_ascii=False)
        PY

        curl "https://oapi.dingtalk.com/robot/send?access_token=$DINGDING_TOKEN" \
          -H 'Content-Type: application/json' \
          -d @dingtalk_message.json